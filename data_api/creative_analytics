"""
CREATIVE_ANALYTICS.PY
 
Purpose: Provides specialized functions to query the Star Schema data warehouse 
for reports focusing on the Creative Dimension (dim_creative).

Functions:
- fetch_creative_breakdown: Fetches metrics grouped by Ad Creative.
"""

import pandas as pd
from sqlalchemy import text
from .db_connector import engine 
from typing import Optional
import logging

logger = logging.getLogger(__name__)

# ----------------------------------------------------------------------
# --- 1. Breakdown Report: Creative ---
# ----------------------------------------------------------------------

def fetch_creative_breakdown(
    start_date: Optional[str] = None, 
    end_date: Optional[str] = None,
    campaign_name: Optional[str] = None
) -> pd.DataFrame:
    """ 
    Fetches aggregated metrics grouped by Creative Name.
    (Assumes using the existing Fact table: fact_core_metrics).
    
    Parameters:
    - start_date (Optional[str]): Start date for filtering (YYYY-MM-DD format).
    - end_date (Optional[str]): End date for filtering (YYYY-MM-DD format).
    - campaign_name (Optional[str]): Filter by specific campaign name.
    
    Returns:
    - pd.DataFrame: Pandas DataFrame with creative metrics and KPIs.
    """
    if engine is None:
        logger.critical("DB Engine is not initialized.")
        return pd.DataFrame()

    sql_query = f"""
    SELECT
        dcrt.creative_name,
        SUM(fcm.spend) AS total_spend,
        SUM(fcm.impressions) AS total_impressions,
        SUM(fcm.clicks) AS total_clicks,
        SUM(fcm.purchases) AS total_purchases,
        -- KPI Calculations (handles division by zero using NULLIF)
        SUM(fcm.clicks)::float / NULLIF(SUM(fcm.impressions), 0) AS "CTR",
        SUM(fcm.spend) / NULLIF(SUM(fcm.clicks), 0) AS "CPC",
        SUM(fcm.spend) / NULLIF(SUM(fcm.purchases), 0) AS "CPA"
    FROM
        fact_core_metrics fcm
    JOIN 
        dim_campaign dca ON fcm.campaign_id = dca.campaign_id
    JOIN 
        dim_creative dcrt ON fcm.creative_id = dcrt.creative_id -- Joining the creative dimension table
    WHERE
        1=1
        {f"AND fcm.date_id >= :start_date" if start_date else ''}
        {f"AND fcm.date_id <= :end_date" if end_date else ''}
        {f"AND dca.campaign_name = :campaign_name" if campaign_name else ''}
    GROUP BY
        dcrt.creative_name
    ORDER BY total_spend DESC;
    """

    params = {}
    # Converts dates to YYYYMMDD format for date_id comparison
    if start_date: params['start_date'] = start_date.replace('-', '')
    if end_date: params['end_date'] = end_date.replace('-', '')
    if campaign_name: params['campaign_name'] = campaign_name
        
    try:
        df = pd.read_sql(text(sql_query), engine, params=params)
        # Fills null/inf values (resulting from NULLIF division) with 0
        df.fillna(0, inplace=True)
        return df
    
    except Exception as e:
        logger.error(f"Error fetching creative breakdown: {e}", exc_info=True)
        return pd.DataFrame()